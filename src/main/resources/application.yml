# ============================================================
# REQUEST GATEWAY SERVICE â€” Unified Configuration
# ============================================================
# All values use: ${ENV_VAR:default_value}
# Dev: default values work out of the box
# Prod: set OS environment variables to override
# ============================================================

spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s
  application:
    name: request-gateway-service

  kafka:
    bootstrap-servers: ${gateway.kafka.bootstrap-servers}
    consumer:
      group-id: ${gateway.kafka.group-id}
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      state-ttl-hours: ${REDIS_STATE_TTL_HOURS:72}
      lock-ttl-seconds: ${REDIS_LOCK_TTL_SECONDS:300}

  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration

# ============================================================
# SERVER
# ============================================================
server:
  port: ${SERVER_PORT:8090}
  shutdown: graceful

# ============================================================
# ACTUATOR & MONITORING
# ============================================================
management:
  server:
    port: ${MANAGEMENT_PORT:8091}
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: always

# ============================================================
# GATEWAY CONFIGURATION
# ============================================================
gateway:

  # --- Kafka ---
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:19092}
    group-id: ${KAFKA_GROUP_ID:gateway-service-group}
    topics:
      request-new: ${KAFKA_TOPIC_REQUEST:gateway.request.new}
      request-response: ${KAFKA_TOPIC_RESPONSE:gateway.request.response}
      request-dlq: ${KAFKA_TOPIC_DLQ:gateway.request.dlq}

  # --- Data Source (Oracle/Biruni) ---
  source:
    base-url: ${SOURCE_BASE_URL:https://app3.greenwhite.uz/x24}
    username: ${SOURCE_USERNAME:admin@head}
    password: ${SOURCE_PASSWORD:greenwhite}
    request-pull-uri: ${SOURCE_PULL_URI:/b/biruni/bmb/requests$pull}
    response-save-uri: ${SOURCE_SAVE_URI:/b/biruni/bmb/requests$save}
    oauth2-provider-uri: ${SOURCE_OAUTH2_PROVIDER_URI:/b/biruni/bmb/requests$get_oauth_provider_data}
    connection-timeout: ${SOURCE_TIMEOUT:60}

  # --- Polling ---
  polling:
    enabled: ${POLLING_ENABLED:true}
    interval-ms: ${POLLING_INTERVAL_MS:5000}
    batch-size: ${POLLING_BATCH_SIZE:100}

  # --- HTTP Client ---
  http:
    connect-timeout-ms: ${HTTP_CONNECT_TIMEOUT:10000}
    read-timeout-ms: ${HTTP_READ_TIMEOUT:30000}
    write-timeout-ms: ${HTTP_WRITE_TIMEOUT:30000}
    endpoint-timeouts: {}

  # --- Retry ---
  retry:
    max-attempts: ${RETRY_MAX_ATTEMPTS:3}
    interval-ms: ${RETRY_INTERVAL_MS:3000}
    retryable-statuses: ${RETRY_STATUSES:408,429,500,502,503,504}

  # --- Dynamic Concurrency ---
  concurrency:
    min-concurrency: ${CONCURRENCY_MIN:10}
    max-concurrency: ${CONCURRENCY_MAX:15}
    monitor-interval-ms: ${CONCURRENCY_MONITOR_INTERVAL:10000}
    scale-up-threshold: ${CONCURRENCY_SCALE_UP:50}
    scale-down-threshold: ${CONCURRENCY_SCALE_DOWN:10}
    scale-step: ${CONCURRENCY_SCALE_STEP:2}
    scale-cooldown-ms: ${CONCURRENCY_COOLDOWN:30000}
    topic-partitions: ${KAFKA_PARTITIONS:10}

  # --- Telegram Notifications ---
  telegram:
    enabled: ${TELEGRAM_ENABLED:true}
    bot-token: ${TELEGRAM_BOT_TOKEN:8318506270:AAGzEwBW46VE-_K_Z__Gcuh8MiPOvBdaVMM}
    chat-id: ${TELEGRAM_CHAT_ID:-1002508752139}
    message-thread-id: ${TELEGRAM_MESSAGE_THREAD_ID:3716}

# ============================================================
# CIRCUIT BREAKER
# ============================================================
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3
        slow-call-duration-threshold: 10s
        slow-call-rate-threshold: 50
        automatic-transition-from-open-to-half-open-enabled: true

# ============================================================
# LOGGING
# ============================================================
logging:
  level:
    root: INFO
    uz.greenwhite.gateway: ${LOG_LEVEL:DEBUG}
    org.apache.kafka.clients.producer.ProducerConfig: WARN
    org.apache.kafka.clients.consumer.ConsumerConfig: WARN
    org.apache.kafka.clients.admin.AdminClientConfig: WARN
    org.apache.kafka: WARN
    org.springframework.kafka.listener: INFO
    org.apache.kafka.clients.Metadata: INFO
  pattern:
    console: "%d{HH:mm:ss.SSS} %-5level [%15.15thread] %-40.40logger{39} : %msg%n"