# ============================================================
# REQUEST GATEWAY SERVICE — Base Configuration
# ============================================================
# Default profile: dev
# Available profiles: dev, prod
# Run with: java -jar gateway.jar --spring.profiles.active=prod
# ============================================================

spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s
  application:
    name: request-gateway-service
  profiles:
    active: ${SPRING_PROFILE:dev}  # Default to dev if not specified

  # Kafka — Spring auto-config
  kafka:
    bootstrap-servers: ${gateway.kafka.bootstrap-servers}
    consumer:
      group-id: ${gateway.kafka.group-id}
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

  # Redis
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      state-ttl-hours: 72
      lock-ttl-seconds: 300


  # JDBC auto-config disabled
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration

# ============================================================
# SERVER
# ============================================================
server:
  port: ${SERVER_PORT:8090}
  shutdown: graceful

# ============================================================
# ACTUATOR & MONITORING
# ============================================================
management:
  server:
    port: ${MANAGEMENT_PORT:8091}
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: always

# ============================================================
# GATEWAY BASE CONFIGURATION
# Profile-specific overrides in application-{profile}.yml
# ============================================================
gateway:

  # --- Kafka (defaults - can be overridden by profiles) ---
  kafka:
    bootstrap-servers: localhost:19092
    group-id: gateway-service-group
    topics:
      request-new: gateway.request.new
      request-response: gateway.request.response
      request-dlq: gateway.request.dlq

  # --- Data Source (defaults) ---
  source:
    base-url: http://localhost:8080
    username: admin
    password: changeme
    request-pull-uri: /api/requests/pull
    response-save-uri: /api/requests/save
    connection-timeout: 60

  # --- Polling ---
  polling:
    enabled: true
    interval-ms: 5000
    batch-size: 100

  # --- HTTP Client ---
  http:
    endpoint-timeouts:
      api.slow-service.com: 60000
      api.fast-service.com: 5000
    connect-timeout-ms: 10000
    read-timeout-ms: 30000
    write-timeout-ms: 30000

  # --- Retry ---
  retry:
    max-attempts: 3
    interval-ms: 3000
    retryable-statuses: 408,429,500,502,503,504

  # --- Dynamic Concurrency ---
  concurrency:
    min-concurrency: 10
    max-concurrency: 15
    monitor-interval-ms: 10000
    scale-up-threshold: 50
    scale-down-threshold: 10
    scale-step: 2
    scale-cooldown-ms: 30000
    topic-partitions: 10

  # --- OAuth2 Providers (empty by default) ---
  oauth2:
    providers:
      supplier1176:
        type: biruni
        token-url: https://app3.greenwhite.uz/xtrade/security/oauth/token
        client-id: E6587DCE827944D33A84CADBE228DA72
        client-secret: 9E4D73C4EF8C05D2DA91326ADDE4BF3CDE6F63A0BBC8A492964B70F5A2FB4A8F589BA197104CD8BD5749F94EBB048115DB9E896EB860FC5F9B79677EAB8AEFA9
        scope: read+write

  # --- Telegram Notifications (disabled by default) ---
  telegram:
    enabled: false
    bot-token: ""
    chat-id: 0
    message-thread-id: null
    connect-timeout-ms: 5000
    read-timeout-ms: 5000

# ============================================================
# CIRCUIT BREAKER (Resilience4j)
# ============================================================
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3
        slow-call-duration-threshold: 10s
        slow-call-rate-threshold: 50
        automatic-transition-from-open-to-half-open-enabled: true