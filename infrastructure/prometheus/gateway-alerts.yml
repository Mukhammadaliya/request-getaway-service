groups:

  # ============================================================
  # 1. SERVICE HEALTH ‚Äî Barcha servicelar UP/DOWN holati
  # ============================================================
  - name: service_health_alerts
    rules:

      - alert: GatewayServiceDown
        expr: up{job="gateway-service"} == 0
        for: 30s
        labels:
          severity: critical
          stage: service
        annotations:
          summary: "üö® Gateway Service ISHLAMAYAPTI"
          description: "Gateway Service (host.docker.internal:8091) 30s davomida javob bermayapti. Polling, consumer, HTTP ‚Äî hammasi to'xtagan."

      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 30s
        labels:
          severity: critical
          stage: service
        annotations:
          summary: "üö® Redis ISHLAMAYAPTI"
          description: "Redis server javob bermayapti. State management, OAuth2 cache, lock ‚Äî barchasi ishlamaydi."

      - alert: RedPandaDown
        expr: up{job="redpanda"} == 0
        for: 30s
        labels:
          severity: critical
          stage: service
        annotations:
          summary: "üö® RedPanda/Kafka ISHLAMAYAPTI"
          description: "Kafka broker javob bermayapti. Message produce/consume to'xtagan."

  # ============================================================
  # 2. JVM & SYSTEM RESOURCES ‚Äî CPU, RAM, Memory, Threads
  # ============================================================
  - name: system_resource_alerts
    rules:

      - alert: HighCpuUsage
        expr: process_cpu_usage{job="gateway-service"} > 0.8
        for: 3m
        labels:
          severity: warning
          stage: system
        annotations:
          summary: "‚ö†Ô∏è CPU yuklama yuqori"
          description: "Gateway Service CPU: {{ $value | printf \"%.0f\" }}% (3 daqiqadan beri > 80%)"

      - alert: CriticalCpuUsage
        expr: process_cpu_usage{job="gateway-service"} > 0.95
        for: 1m
        labels:
          severity: critical
          stage: system
        annotations:
          summary: "üö® CPU KRITIK darajada yuqori"
          description: "Gateway Service CPU: {{ $value | printf \"%.0f\" }}% ‚Äî Service hang bo'lishi mumkin."

      - alert: HighHeapMemory
        expr: jvm_memory_used_bytes{job="gateway-service", area="heap"} / jvm_memory_max_bytes{job="gateway-service", area="heap"} > 0.8
        for: 3m
        labels:
          severity: warning
          stage: system
        annotations:
          summary: "‚ö†Ô∏è JVM Heap memory yuqori"
          description: "Heap ishlatilishi: {{ $value | printf \"%.0f\" }}% (max dan). OutOfMemory xavfi bor."

      - alert: CriticalHeapMemory
        expr: jvm_memory_used_bytes{job="gateway-service", area="heap"} / jvm_memory_max_bytes{job="gateway-service", area="heap"} > 0.95
        for: 1m
        labels:
          severity: critical
          stage: system
        annotations:
          summary: "üö® JVM Heap KRITIK ‚Äî OutOfMemory yaqin"
          description: "Heap: {{ $value | printf \"%.0f\" }}% to'lgan. Ilova crash bo'lishi mumkin."

      - alert: HighGcPause
        expr: rate(jvm_gc_pause_seconds_sum{job="gateway-service"}[5m]) > 0.5
        for: 3m
        labels:
          severity: warning
          stage: system
        annotations:
          summary: "‚ö†Ô∏è GC pause vaqti yuqori"
          description: "Garbage Collection juda ko'p vaqt olayapti: {{ $value | printf \"%.2f\" }}s/sec. Memory pressure bor."

      - alert: HighThreadCount
        expr: jvm_threads_live_threads{job="gateway-service"} > 200
        for: 3m
        labels:
          severity: warning
          stage: system
        annotations:
          summary: "‚ö†Ô∏è Thread soni yuqori"
          description: "Live threads: {{ $value | printf \"%.0f\" }}. Thread leak bo'lishi mumkin."

  # ============================================================
  # 3. E1: ORACLE PULL ‚Äî Polling va auth hatoliklari
  # ============================================================
  - name: oracle_pull_alerts
    rules:

      - alert: OraclePullDown
        expr: increase(gateway_oracle_pull_total{result="error"}[5m]) > 0 and increase(gateway_oracle_pull_total{result="success"}[5m]) == 0
        for: 5m
        labels:
          severity: critical
          stage: oracle_pull
        annotations:
          summary: "üö® Oracle Pull to'liq ishlamayapti"
          description: "5 daqiqa davomida Oracle'dan birorta request pull qilinmadi. Auth xatolik, connection refused yoki Oracle down bo'lishi mumkin."

      - alert: OraclePullErrors
        expr: rate(gateway_oracle_pull_total{result="error"}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          stage: oracle_pull
        annotations:
          summary: "‚ö†Ô∏è Oracle Pull xatoliklari"
          description: "Oracle pull error rate: {{ $value | printf \"%.2f\" }}/sec. Auth, connection yoki network xatolik bo'lishi mumkin."

      - alert: OraclePullSlow
        expr: histogram_quantile(0.95, rate(gateway_oracle_pull_duration_seconds_bucket[5m])) > 5
        for: 3m
        labels:
          severity: warning
          stage: oracle_pull
        annotations:
          summary: "‚ö†Ô∏è Oracle Pull sekin"
          description: "Oracle pull p95 latency: {{ $value | printf \"%.2f\" }}s. Oracle yoki network sekin."

  # ============================================================
  # 4. E2: KAFKA PRODUCE ‚Äî Requestni topicga yuborish
  # ============================================================
  - name: kafka_produce_alerts
    rules:

      - alert: KafkaProduceErrors
        expr: rate(gateway_kafka_produce_total{result="error"}[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
          stage: kafka_produce
        annotations:
          summary: "‚ö†Ô∏è Kafka produce xatoliklari"
          description: "Requestlarni Kafka topicga yuborishda error rate: {{ $value | printf \"%.2f\" }}/sec. Kafka connection yoki serialization xatolik."

      - alert: KafkaProduceHighRetry
        expr: rate(gateway_kafka_produce_retry_total[5m]) > 0.5
        for: 3m
        labels:
          severity: warning
          stage: kafka_produce
        annotations:
          summary: "‚ö†Ô∏è Kafka produce retry ko'p"
          description: "Kafka produce retry rate: {{ $value | printf \"%.2f\" }}/sec. Kafka broker nobarqaror."

      - alert: KafkaProduceSlow
        expr: histogram_quantile(0.95, rate(gateway_kafka_produce_duration_seconds_bucket[5m])) > 3
        for: 3m
        labels:
          severity: warning
          stage: kafka_produce
        annotations:
          summary: "‚ö†Ô∏è Kafka produce sekin"
          description: "Kafka produce p95: {{ $value | printf \"%.2f\" }}s. Broker yuki yuqori bo'lishi mumkin."

  # ============================================================
  # 5. E3: CONSUMER ‚Äî Request consume va Redis state
  # ============================================================
  - name: consumer_alerts
    rules:

      - alert: ConsumerNotReceiving
        expr: rate(gateway_consumer_received_total[5m]) == 0 and gateway_kafka_consumer_lag > 0
        for: 5m
        labels:
          severity: critical
          stage: consumer_process
        annotations:
          summary: "üö® Consumer message qabul qilmayapti"
          description: "Lag bor ({{ $value | printf \"%.0f\" }}) lekin consumer hech narsa consume qilmayapti. Consumer hang yoki crash bo'lgan."

      - alert: ConsumerHighDuplicateSkip
        expr: rate(gateway_consumer_skipped_total{reason="duplicate"}[5m]) > 1
        for: 3m
        labels:
          severity: warning
          stage: consumer_process
        annotations:
          summary: "‚ö†Ô∏è Duplicate skip ko'p"
          description: "Duplicate skip rate: {{ $value | printf \"%.2f\" }}/sec. Redis state yoki Kafka rebalance muammo."

      - alert: ConsumerHighLockFail
        expr: rate(gateway_consumer_skipped_total{reason="lock_failed"}[5m]) > 0.5
        for: 3m
        labels:
          severity: warning
          stage: consumer_process
        annotations:
          summary: "‚ö†Ô∏è Redis lock xatoliklari ko'p"
          description: "Lock fail rate: {{ $value | printf \"%.2f\" }}/sec. Redis connection yoki lock contention muammo."

      - alert: KafkaConsumerHighLag
        expr: gateway_kafka_consumer_lag > 500
        for: 5m
        labels:
          severity: warning
          stage: consumer_process
        annotations:
          summary: "‚ö†Ô∏è Kafka consumer lag yuqori"
          description: "{{ $labels.listener }} lag: {{ $value | printf \"%.0f\" }} messages. Consumer yetishmayapti."

      - alert: KafkaConsumerCriticalLag
        expr: gateway_kafka_consumer_lag > 2000
        for: 3m
        labels:
          severity: critical
          stage: consumer_process
        annotations:
          summary: "üö® Kafka consumer lag KRITIK"
          description: "{{ $labels.listener }} lag: {{ $value | printf \"%.0f\" }}. Scale up yoki muammo hal qilish kerak."

  # ============================================================
  # 6. E4: HTTP REQUEST ‚Äî Barcha HTTP xatoliklari
  # ============================================================
  - name: http_request_alerts
    rules:

      - alert: HttpHighErrorRate
        expr: >
          (
            rate(gateway_http_request_total{result=~"error_4xx|error_5xx|timeout"}[5m])
          ) / (
            rate(gateway_http_request_total{result="success"}[5m]) + 0.001
          ) > 0.3
        for: 3m
        labels:
          severity: warning
          stage: http_request
        annotations:
          summary: "‚ö†Ô∏è HTTP error rate 30% dan oshdi"
          description: "External API ga so'rovlarning 30%+ xato qaytayapti."

      - alert: Http4xxClientErrors
        expr: rate(gateway_http_request_total{result="error_4xx"}[5m]) > 0.2
        for: 3m
        labels:
          severity: warning
          stage: http_request
        annotations:
          summary: "‚ö†Ô∏è HTTP 4xx client xatoliklari"
          description: "4xx error rate: {{ $value | printf \"%.2f\" }}/sec. Auth (401/403), not found (404), yoki bad request (400)."

      - alert: Http5xxServerErrors
        expr: rate(gateway_http_request_total{result="error_5xx"}[5m]) > 0.2
        for: 2m
        labels:
          severity: critical
          stage: http_request
        annotations:
          summary: "üö® HTTP 5xx server xatoliklari"
          description: "5xx error rate: {{ $value | printf \"%.2f\" }}/sec. External API server xatolik qaytaryapti (500/502/503)."

      - alert: HttpTimeoutSpike
        expr: rate(gateway_http_request_total{result="timeout"}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          stage: http_request
        annotations:
          summary: "‚ö†Ô∏è HTTP timeout ko'paydi"
          description: "Timeout rate: {{ $value | printf \"%.2f\" }}/sec. External API javob bermayapti yoki network sekin."

      - alert: HttpSlowResponse
        expr: histogram_quantile(0.95, rate(gateway_http_request_duration_seconds_bucket[5m])) > 10
        for: 3m
        labels:
          severity: warning
          stage: http_request
        annotations:
          summary: "‚ö†Ô∏è HTTP response sekin"
          description: "HTTP p95 latency: {{ $value | printf \"%.2f\" }}s. External API sekin javob beryapti."

      - alert: HttpRetryHigh
        expr: rate(gateway_http_request_retry_total[5m]) > 0.5
        for: 3m
        labels:
          severity: warning
          stage: http_request
        annotations:
          summary: "‚ö†Ô∏è HTTP retry ko'p"
          description: "HTTP retry rate: {{ $value | printf \"%.2f\" }}/sec. External API nobarqaror."

      - alert: CircuitBreakerOpen
        expr: increase(gateway_http_circuitbreaker_rejected_total[5m]) > 0
        for: 30s
        labels:
          severity: critical
          stage: http_request
        annotations:
          summary: "üö® Circuit Breaker OCHILDI"
          description: "External API ga so'rovlar Circuit Breaker tomonidan rad qilinyapti. API ishlamayotgan bo'lishi mumkin."

  # ============================================================
  # 7. E5: ORACLE SAVE ‚Äî Response saqlash
  # ============================================================
  - name: oracle_save_alerts
    rules:

      - alert: OracleSaveErrors
        expr: rate(gateway_oracle_save_total{result="error"}[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          stage: oracle_save
        annotations:
          summary: "üö® Oracle save xatoliklari"
          description: "Response'larni Oracle'ga saqlashda error rate: {{ $value | printf \"%.2f\" }}/sec. Oracle connection, auth yoki data xatolik."

      - alert: OracleSaveRetryHigh
        expr: rate(gateway_oracle_save_retry_total[5m]) > 0.3
        for: 3m
        labels:
          severity: warning
          stage: oracle_save
        annotations:
          summary: "‚ö†Ô∏è Oracle save retry ko'p"
          description: "Oracle save retry rate: {{ $value | printf \"%.2f\" }}/sec. Oracle connection nobarqaror."

      - alert: OracleSaveSlow
        expr: histogram_quantile(0.95, rate(gateway_oracle_save_duration_seconds_bucket[5m])) > 5
        for: 3m
        labels:
          severity: warning
          stage: oracle_save
        annotations:
          summary: "‚ö†Ô∏è Oracle save sekin"
          description: "Oracle save p95: {{ $value | printf \"%.2f\" }}s. Oracle server yoki network sekin."

  # ============================================================
  # 8. DLQ ‚Äî Dead Letter Queue
  # ============================================================
  - name: dlq_alerts
    rules:

      - alert: DlqMessagesDetected
        expr: increase(gateway_dlq_sent_total[5m]) > 0
        for: 1m
        labels:
          severity: warning
          stage: dlq
        annotations:
          summary: "‚ö†Ô∏è DLQ ga message tushdi"
          description: "Oxirgi 5 daqiqada {{ $value | printf \"%.0f\" }} ta message DLQ ga tushdi. Barcha retrylar muvaffaqiyatsiz."

      - alert: DlqSpike
        expr: increase(gateway_dlq_sent_total[5m]) > 10
        for: 1m
        labels:
          severity: critical
          stage: dlq
        annotations:
          summary: "üö® DLQ SPIKE ‚Äî massiv failure"
          description: "5 daqiqada {{ $value | printf \"%.0f\" }} ta message DLQ ga tushdi. Tizimda jiddiy muammo."

  # ============================================================
  # 9. CONCURRENCY & THREAD POOL
  # ============================================================
  - name: concurrency_alerts
    rules:

      - alert: HttpPoolExhausted
        expr: gateway_http_pool_queue > 20
        for: 2m
        labels:
          severity: warning
          stage: concurrency
        annotations:
          summary: "‚ö†Ô∏è HTTP thread pool queue to'lmoqda"
          description: "Queue size: {{ $value | printf \"%.0f\" }}. Thread pool yetishmayapti, requestlar kutmoqda."

      - alert: HttpPoolFullyActive
        expr: gateway_http_pool_active / gateway_http_pool_size > 0.9
        for: 3m
        labels:
          severity: warning
          stage: concurrency
        annotations:
          summary: "‚ö†Ô∏è HTTP thread pool 90%+ band"
          description: "Active: {{ $value | printf \"%.0f\" }}% band. Thread pool max ga yaqin."

      - alert: HighRetryRate
        expr: >
          (
            rate(gateway_kafka_produce_retry_total[5m])
            + rate(gateway_http_request_retry_total[5m])
            + rate(gateway_oracle_save_retry_total[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          stage: all
        annotations:
          summary: "‚ö†Ô∏è Umumiy retry rate yuqori"
          description: "Umumiy retry: {{ $value | printf \"%.2f\" }}/sec. Tizimda nobarqarorlik bor."

  # ============================================================
  # 10. REDIS HEALTH ‚Äî Memory, connections, performance
  # ============================================================
  - name: redis_health_alerts
    rules:

      - alert: RedisHighMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 3m
        labels:
          severity: warning
          stage: redis
        annotations:
          summary: "‚ö†Ô∏è Redis memory 80% dan oshdi"
          description: "Redis memory: {{ $value | printf \"%.0f\" }}% ishlatilgan. Eviction boshlanishi mumkin."

      - alert: RedisCriticalMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.95
        for: 1m
        labels:
          severity: critical
          stage: redis
        annotations:
          summary: "üö® Redis memory KRITIK"
          description: "Redis memory 95%+ to'lgan. Key eviction va data loss xavfi."

      - alert: RedisHighEviction
        expr: rate(redis_evicted_keys_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          stage: redis
        annotations:
          summary: "‚ö†Ô∏è Redis key eviction ko'p"
          description: "Eviction rate: {{ $value | printf \"%.1f\" }} keys/sec. Memory yetishmayapti, state yo'qolishi mumkin."

      - alert: RedisConnectionRejected
        expr: rate(redis_rejected_connections_total[5m]) > 0
        for: 1m
        labels:
          severity: warning
          stage: redis
        annotations:
          summary: "‚ö†Ô∏è Redis connection rad qilyapti"
          description: "Redis yangi connectionlarni rad qilayapti. Max connection limitga yetgan."

      - alert: RedisLowHitRate
        expr: redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total + 0.001) < 0.5
        for: 5m
        labels:
          severity: warning
          stage: redis
        annotations:
          summary: "‚ö†Ô∏è Redis cache hit rate past"
          description: "Hit rate: {{ $value | printf \"%.0f\" }}%. OAuth2 token yoki state cache samarasiz ishlayapti."

  # ============================================================
  # 11. REDPANDA/KAFKA HEALTH
  # ============================================================
  - name: redpanda_health_alerts
    rules:

      - alert: KafkaRequestErrors
        expr: sum(rate(redpanda_kafka_request_errors_total[5m])) > 0.5
        for: 2m
        labels:
          severity: warning
          stage: kafka
        annotations:
          summary: "‚ö†Ô∏è Kafka request xatoliklari"
          description: "Kafka error rate: {{ $value | printf \"%.2f\" }}/sec. Produce yoki consume da muammo."

      - alert: KafkaProduceLatencyHigh
        expr: histogram_quantile(0.95, rate(redpanda_kafka_request_produce_latency_seconds_bucket[5m])) > 1
        for: 3m
        labels:
          severity: warning
          stage: kafka
        annotations:
          summary: "‚ö†Ô∏è Kafka produce latency yuqori"
          description: "Produce p95: {{ $value | printf \"%.2f\" }}s. Broker yuki yuqori."

      - alert: KafkaStorageGrowing
        expr: predict_linear(sum by (redpanda_topic) (redpanda_kafka_partition_log_size_bytes{redpanda_topic=~"bmb.request.*"})[1h:5m], 86400) > 5368709120
        for: 10m
        labels:
          severity: warning
          stage: kafka
        annotations:
          summary: "‚ö†Ô∏è Kafka storage tez o'smoqda"
          description: "Hozirgi tezlikda 24 soatda 5GB dan oshadi. Retention policy tekshiring."